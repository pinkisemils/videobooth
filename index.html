<html>
<head>
    <title>Video Guestbook</title>
    <style>
    * { margin: 0; }
    body {
        font-family: "Open Sans";
    }
    .fullscreen #main, .fullscreen video {
        width: 100%;
        height: 100%;
    }
    #main {
        position: relative;
    }
    #overlay {
        position: absolute;
        height: 2em;
        width: 100%;
        color: white;
        text-align: center;
        font-size: 72;
    }
    </style>
</head>
<body>
    <div>
    <div id="main">
    <div id="overlay">HELLO</div>
    <video autoplay muted></video>
    </div>
    </div>

    <button onclick="document.querySelector('#main').requestFullscreen().then(function(_) {document.querySelector('#main').classList.add('fullscreen')});">hi</button>

    <script language="javascript" type="text/javascript">
        "use strict";

        const server = "/recording";

        let webcamstream;
        let recorder;

        let state = 'idle';

        const overlay = document.querySelector('#overlay');

        window.addEventListener('keydown', function(e) {
            if (e.code == 'Space') {
                e.preventDefault();
                if (state == 'idle') {
                    recorder = new MediaRecorder(webcamstream, {
                        videoBitsPerSecond: 10000000,
                    });
                    recorder.ondataavailable = function(e) {
                        let data = e.data;
                        let xhr = new XMLHttpRequest();
                        overlay.textContent = 'Saving...';
                        xhr.open('POST', server);
                        xhr.onreadystatechange = function() {
                            if (this.readyState != XMLHttpRequest.DONE) { return; }
                            state = 'idle';
                            overlay.textContent = 'Done';
                        };
                        xhr.send(data);
                        //let link = document.createElement('a');
                        //link.href = URL.createObjectURL(data);
                        //link.download = 'asdf.webm';
                        //link.click();
                        console.log(e);
                    };
                    recorder.start();
                    state = 'record';
                    overlay.textContent = 'Recording';
                } else if (state == 'record') {
                    recorder.stop();
                    recorder = null;
                    state = 'save';
                }
            }
        });

        navigator.getUserMedia({audio: true, video: true}, function(stream) {
            let video = document.querySelector('video');
            webcamstream = stream;
            video.srcObject = stream;
            //video.onloadedmetadata = function(e) {
            //    video.play();
            //}
        }, function(e) { console.log(e); });
    </script>
</
body>
